<!DOCTYPE html>
<html>
<head>
    <title>VR Robot Asisten Ros</title>
    <meta name="description" content="An interactive VR disaster preparedness assistant robot for mobile phones.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- A-Frame Library -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        #ui-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            z-index: 10;
            font-family: Arial, sans-serif;
            text-align: center;
            pointer-events: none;
        }
        #mic-button {
            width: 80px;
            height: 80px;
            background-color: #4CAF50;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            margin-bottom: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
            pointer-events: auto;
        }
        #mic-button:active {
            transform: scale(0.95);
        }
        #mic-button.listening {
            background-color: #F44336;
            animation: pulse 1.5s infinite;
        }
        #mic-icon {
            width: 40px;
            height: 40px;
            fill: white;
        }
        #initial-instruction {
            color: white;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 20px;
            margin-bottom: 15px;
            font-size: 16px;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(244, 67, 54, 0); }
            100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
        }
    </style>
    <script>
        AFRAME.registerComponent('voice-listener', {
            init: function() {
                const answerTextEl = document.querySelector('#answer-text');
                const speechBubbleEl = document.querySelector('#speech-bubble');
                const speechBubbleBgEl = document.querySelector('#speech-bubble-bg');
                const robotHeadEl = document.querySelector('#robot-head');
                const knowledgePanelEl = document.querySelector('#knowledge-panel');
                const micButton = document.getElementById('mic-button');
                const initialInstruction = document.getElementById('initial-instruction');
                const vrMicIndicator = document.querySelector('#vr-mic-indicator');

                let conversationState = 'IDLE';
                let userName = '';
                let typeInterval;

                const qaDatabase = { /* database sama seperti sebelumnya */ };
                const storyPrompts = { "Buat Cerita âœ¨": { "Cerita tentang Gempa": "gempa bumi", "Cerita tentang Banjir": "banjir", "Cerita tentang Gunung Meletus": "gunung meletus", "Cerita tentang Kebakaran": "kebakaran" } };

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const speechSynthesis = window.speechSynthesis;
                let recognition;
                let indonesianVoice = null;

                function findIndonesianVoice() {
                    const voices = speechSynthesis.getVoices();
                    indonesianVoice = voices.find(voice => voice.lang === 'id-ID') || voices.find(voice => voice.name.includes('Indonesian'));
                }
                findIndonesianVoice();
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = findIndonesianVoice;
                }

                const toggleMic = () => {
                    if (!SpeechRecognition) {
                        alert("Maaf, browser ini tidak mendukung fitur suara.");
                        return;
                    }

                    if (!recognition) {
                        recognition = new SpeechRecognition();
                        recognition.lang = 'id-ID';
                        recognition.interimResults = false;
                        recognition.continuous = false;

                        recognition.onstart = () => {
                            micButton.classList.add('listening');
                            if (vrMicIndicator) vrMicIndicator.setAttribute('scale', '1.2 1.2 1.2');
                        };
                        recognition.onend = () => {
                            micButton.classList.remove('listening');
                            if (vrMicIndicator) vrMicIndicator.setAttribute('scale', '1 1 1');
                        };
                        recognition.onresult = (event) => {
                            const command = event.results[event.results.length - 1][0].transcript;
                            console.log("Recognized:", command);
                            // TODO: panggil processCommand(command)
                        };
                        recognition.onerror = (event) => console.error('Speech recognition error:', event.error);
                    }

                    if (initialInstruction) initialInstruction.style.display = 'none';
                    recognition.start();
                };

                micButton.addEventListener('click', toggleMic);
                if (vrMicIndicator) vrMicIndicator.addEventListener('click', toggleMic);
            }
        });
    </script>
</head>
<body>
    <div id="ui-overlay">
        <div id="initial-instruction">Ketuk ikon mic di bawah untuk bicara (juga saat mode VR)</div>
        <div id="mic-button" title="Ketuk untuk Bicara">
            <svg id="mic-icon" viewBox="0 0 24 24">
                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/>
            </svg>
        </div>
    </div>

    <a-scene background="color: #87CEEB" voice-listener>
        <a-camera>
            <a-cursor id="cursor" raycaster="objects: .clickable" fuse="true" fuse-timeout="2000">
                <a-entity geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03; thetaLength: 0" material="color: #007BFF; shader: flat; opacity: 0.8" animation__fusing="property: geometry.thetaLength; from: 0; to: 360; startEvents: fusing; dur: 2000; easing: linear" animation__reset="property: geometry.thetaLength; to: 0; startEvents: mouseleave; dur: 0"></a-entity>
            </a-cursor>
            <a-entity id="vr-mic-indicator" position="0 -0.8 -1.5" visible="true">
                <a-plane width="0.3" height="0.3" color="#000000" opacity="0.5" rounded="0.15"></a-plane>
                <a-entity geometry="primitive: plane; width: 0.2; height: 0.2" material="src: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0id2hpdGUiPjxwYXRoIGQ9Ik0xMiAxNGMxLjY2IDAgMy0xLjM0IDMtM1Y1YzAtMS42Ni0xLjM0LTMtMy0zUzkgMy4zNCA5IDV2NmMwIDEuNjYgMS4zNCAzIDMgM3ptNS4zLTNjMCAzLTIuNTQgNS4xLTUuMyA1LjFTNi43IDE0IDYuNyAxMUg1YzAgMy40MSAyLjcyIDYuMjMgNiA2LjcyVjIxaDJ2LTMuMjhjMy4yOC0uNDkgNi0zLjMxIDYtNi43MmgtMS43eiIvPjwvc3ZnPg==); transparent: true;" position="0 0 0.01"></a-entity>
            </a-entity>
        </a-camera>

        <a-light type="ambient" color="#AAA"></a-light>
        <a-light type="directional" intensity="0.5" position="-1 1 2"></a-light>

        <a-entity id="robot" position="0 0.7 -3">
            <a-text value="Ros" color="#333" position="0 2.1 0" align="center" width="5"></a-text>
            <a-entity id="speech-bubble" position="0 2.5 0" visible="false">
                <a-plane id="speech-bubble-bg" color="#FFFFFF" width="2.5" height="1" rounded="0.2" position="0 0 -0.01"></a-plane>
                <a-triangle color="#FFFFFF" vertex-a="0 -0.5 0" vertex-b="-0.2 -0.7 0" vertex-c="0.2 -0.7 0"></a-triangle>
                <a-text id="answer-text" value="" color="#00008B" width="2.3" align="left" wrap-count="35"></a-text>
            </a-entity>
            <a-entity id="robot-head" position="0 1.2 0">
                <a-box position="0 0 0" width="0.9" height="0.8" depth="0.8" color="#FFFFFF" shadow>
                    <a-box position="0 0 0.41" width="0.7" height="0.6" depth="0.05" color="#87CEEB"></a-box>
                    <a-box position="-0.15 0.1 0.44" width="0.1" height="0.15" depth="0.05" color="#2C3E50"></a-box>
                    <a-box position="0.15 0.1 0.44" width="0.1" height="0.15" depth="0.05" color="#2C3E50"></a-box>
                    <a-entity position="0 -0.1 0.44" geometry="primitive: torus; radius: 0.12; radiusTubular: 0.02; arc: 180" material="color: #2C3E50" rotation="0 0 180"></a-entity>
                </a-box>
                <a-entity id="grad-cap" position="0 0.4 0">
                    <a-box position="0 0.1 0" width="1.2" height="0.1" depth="1.2" color="#34495E"></a-box>
                    <a-cylinder position="0 0 0" radius="0.3" height="0.2" color="#34495E"></a-cylinder>
                    <a-cylinder position="0.3 0.1 0" radius="0.01" height="0.3" color="#FFC107"></a-cylinder>
                </a-entity>
            </a-entity>
            <a-box id="robot-body" position="0 0.5 0" width="0.6" height="0.8" depth="0.6" color="#BDC3C7" shadow></a-box>
            <a-cylinder position="-0.4 0.6 0" radius="0.1" height="0.4" color="#FFFFFF" rotation="0 0 30" shadow></a-cylinder>
            <a-cylinder position="0.4 0.6 0" radius="0.1" height="0.4" color="#FFFFFF" rotation="0 0 -30" shadow></a-cylinder>
            <a-cylinder position="-0.15 0 0" radius="0.15" height="0.2" color="#FFFFFF" shadow></a-cylinder>
            <a-cylinder position="0.15 0 0" radius="0.15" height="0.2" color="#FFFFFF" shadow></a-cylinder>
        </a-entity>

        <a-entity id="knowledge-panel" position="0 0 -2.5" visible="false"></a-entity>

        <a-plane position="0 0 -5" rotation="-90 0 0" width="20" height="20" color="#90EE90" shadow></a-plane>
    </a-scene>
</body>
</html>
